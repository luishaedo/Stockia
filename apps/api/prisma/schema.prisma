generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum FacturaEstado {
  DRAFT
  FINAL
}

model Factura {
  id          String        @id @default(uuid())
  nroFactura  String        @unique
  proveedor   String?
  createdBy   String?
  fecha       DateTime      @default(now())
  estado      FacturaEstado @default(DRAFT)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  items       FacturaItem[]

  // Indexes for list filtering
  @@index([estado])
  @@index([fecha])
  @@index([nroFactura])
  @@index([proveedor])
  @@index([createdBy])
  @@index([estado, fecha])
}

model FacturaItem {
  id             String   @id @default(uuid())
  facturaId      String
  factura        Factura  @relation(fields: [facturaId], references: [id], onDelete: Cascade)
  
  marca          String
  tipoPrenda     String
  codigoArticulo String
  curvaTalles    String[] // Stored as array of strings
  
  colores        FacturaItemColor[]

  // Enforce uniqueness of Article within a Factura
  @@unique([facturaId, marca, tipoPrenda, codigoArticulo])
  @@index([facturaId])
}

model FacturaItemColor {
  id                 String      @id @default(uuid())
  facturaItemId      String
  facturaItem        FacturaItem @relation(fields: [facturaItemId], references: [id], onDelete: Cascade)
  
  codigoColor        String
  nombreColor        String
  cantidadesPorTalle Json        // JSONB type for { "S": 1, "M": 2 }

  // Enforce uniqueness of Color within an Item
  @@unique([facturaItemId, codigoColor])
  @@index([facturaItemId])
}

model Supplier {
  id        String   @id @default(uuid())
  code      String   @unique
  name      String
  logoUrl   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([code])
  @@index([name])
}

model Family {
  id          String   @id @default(uuid())
  code        String   @unique
  description String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([code])
  @@index([description])
}

model GarmentType {
  id          String   @id @default(uuid())
  code        String   @unique
  description String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([code])
  @@index([description])
}

model Material {
  id          String   @id @default(uuid())
  code        String   @unique
  description String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([code])
  @@index([description])
}

model Classification {
  id          String   @id @default(uuid())
  code        String   @unique
  description String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([code])
  @@index([description])
}

model Category {
  id              String   @id @default(uuid())
  code            String   @unique
  description     String
  longDescription String?
  logoUrl         String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([code])
  @@index([description])
}

model SizeCurve {
  id          String           @id @default(uuid())
  code        String           @unique
  description String
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  values      SizeCurveValue[]

  @@index([code])
  @@index([description])
}

model SizeCurveValue {
  id          String    @id @default(uuid())
  sizeCurveId String
  value       String
  sortOrder   Int
  sizeCurve   SizeCurve @relation(fields: [sizeCurveId], references: [id], onDelete: Cascade)

  @@unique([sizeCurveId, value])
  @@unique([sizeCurveId, sortOrder])
  @@index([sizeCurveId])
}
